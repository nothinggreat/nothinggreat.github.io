<!DOCTYPE html>
<html>
<head>
  <title>Mortgage Simulator  </title>
</head>

<body>
<!--<p>
   <div id = "world">World 1</div>
</p>-->
</p><div id="intructions">
  <div>---Mortgage Simulator---</div>
  <div>Press Spacebar to advance a month (hold to go fast)</div>
  <div>Press Tab to advance 12 months (hold to go fast)</div>
  <div>Press S to skip to the end making all payments</div>
  <div>Press R to refinance</div>
  <div>Press P to pay off the loan</div>
  <div>Press ESC to start over</div>
</div></p>
<p>
   <div>---Overall---</div>
   <div id = "cumulative_payments">Cumulative Payments=$0</div>
</p>
<p>
   <div>---Finances---</div>
   <div id = "cash">Current Cash=$0</div>
   <div id = "income">Current Income=$3,000</div>
</p>
<p>
  <div>---Loan---</div>
  <div id = "balance">Current Balance=$400,000</div>
  <div id = "rem_term">Remaining Term=360</div>
  <div id = "loan_rate">Current Rate=4%</div>
  <div id = "payment">Current Payment=$1909.66</div>
</p>
</div></p>
</p>
  <div>---Rates---</div>
  <div id="term">Term=360</div>
  <div id="new_rate">Rate=4%</div>
  <div id="fees">Fees=$0</div>
</div></p>
</p>
   <div>---Message---</div>
   <div id="message"></div>
</p>

<script>
var cumulative_payments = 0;
var cash = 0;
var income = 4000;

var balance = 400000;
var rem_term = 360;
var loan_rate = 4;
var payment = 1909.66;

var new_term = 360;
var new_rate = 4;
var new_fees = 0;
var change = 0.005;

var rate_history = [];
rate_history[0] = new_rate;
var gameover = false;

// Standard Normal variate using Box-Muller transform.
function randn(mean,stdev) {
    var u = 0, v = 0;
    while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
    while(v === 0) v = Math.random();
    return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v ) * stdev + mean;
}
function pmt(balance, term, rate)
{
	var r = rate / 1200;
	var payment = (balance * r) / (1 - (Math.pow( (1 + r) , term * -1)));
	return payment;
}
function sched_bal(balance, term, rate, age)
{
	var r = rate / 1200;
	var sched_bal = balance * (Math.pow(1+r,term) - Math.pow(1+r,age)) / (Math.pow(1+r,term) - 1);
	return sched_bal;
}
function ipmt(balance, term, rate)
{
	var interest = balance * rate / 1200;
	return interest;
}
function ppmt(balance, term, rate)
{
	var payment = pmt(balance, term, rate);
	var interest = ipmt(balance, term, rate);
	var principal = payment - interest;
	return principal;
}
function update(elem,text)
{
	document.getElementById(elem).innerHTML = text;
}
function update_payment()
{
   payment = pmt(balance, rem_term, loan_rate);
   payment = +(payment.toFixed(2));

   update("payment","Current Payment=$" + payment);
}

function update_rates()
{
   bigjump = Math.random() < 0.1;
   if (bigjump)
   {
       change = randn(0,0.25)
   }
   else
   {
       change = randn(change/10,0.05)
   }
   new_rate = new_rate + change
   new_rate = +(new_rate.toFixed(2));
   rate_history[rate_history.length] = new_rate;
   update("new_rate", "Rate=" + new_rate +"%");
}
function next_month()
{
   if (gameover)
      return;

   //finances
   cumulative_payments = cumulative_payments + payment;
   cash = cash + income - payment;
   cash = +(cash.toFixed(2));

   //loan
   var principal = ppmt(balance, rem_term, loan_rate);
   balance = balance - principal;
   rem_term = rem_term - 1;

   balance = +(balance.toFixed(2));

   //rates
   update_rates()

   //display
   update("cumulative_payments", "Cumulative Payments=$" + dollar(cumulative_payments));
   update("cash", "Current Cash=$" + dollar(cash));
   update("balance", "Current Balance=$" + dollar(balance));
   update("rem_term", "Remaining Term=" + rem_term);
   update("message","")

   if (rem_term == 0)
   {
   	  optimized_refi_path("Loan is paid off!");
      gameover=true;
   }
}
function refi()
{
    if (cash < new_fees)
    {
    	update("message","Not Enough Cash to Refi")
    	return;
    }

	loan_rate = new_rate;
	rem_term = new_term;
	cash = cash - new_fees;
	cumulative_payments = cumulative_payments + new_fees;
	payment = pmt(balance, rem_term, loan_rate)
    payment = +(payment.toFixed(2));

    update("cumulative_payments", "Cumulative Payments=$" + dollar(cumulative_payments));
    update("balance", "Current Balance=$" + dollar(balance));
    update("rem_term", "Remaining Term=" + rem_term);
    update("loan_rate","Current Rate=" + loan_rate + "%");
    update("payment","Current Payment=$" + dollar(payment));
    update("cash","Current Cash=$" + dollar(cash));
    update("message","Refi Successful!")
}
function skip(months=rem_term)
{
	var i;
	var months_left = Math.min(months,rem_term);
    for (i=0;i<months_left;i++)
	{
		next_month();
	}
    update("cumulative_payments", "Cumulative Payments=$" + dollar(cumulative_payments));
    update("balance", "Current Balance=$" + dollar(balance));
    update("rem_term", "Remaining Term=" + rem_term);
    update("loan_rate","Current Rate=" + loan_rate + "%");
    update("payment","Current Payment=$" + dollar(payment));
    update("cash","Current Cash=$" + dollar(cash));
}
function payoff()
{
    if (cash < new_fees)
    {
    	update("message","Not Enough Cash to Pay Off Loan")
    	return;
    }

	cumulative_payments = cumulative_payments + balance;
    balance = 0;
    rem_term = 0;
    loan_rate = 0;
    payment = 0;

    update("cumulative_payments", "Cumulative Payments=$" + dollar(cumulative_payments));
    update("balance", "Current Balance=$" + dollar(balance));
    update("rem_term", "Remaining Term=" + rem_term);
    update("loan_rate","Current Rate=" + loan_rate + "%");
    update("payment","Current Payment=$" + dollar(payment));
    update("cash","Current Cash=$" + dollar(cash));
    optimized_refi_path("Payoff Successful!");
    gameover=true;
}
function dollar(val)
{
	val = +(val.toFixed(2));
	return val.toLocaleString()
}
function round(val)
{
	val = +(val.toFixed(2));
	return val;
}

function optimized_refi_path(message)
{
    //assume you refi-ed at min rate
    var starting_payment = 1909.66;
    var starting_term = 360;
    var starting_balance = 400000;
    var starting_rate = 4;
	var payoff_age = 210;
	var payoff_bal = sched_bal(starting_balance, starting_term, starting_rate, payoff_age);
	var total_payments_naive = starting_payment * starting_term;

    var max_rate = Math.max.apply(Math,rate_history);
    var min_rate = Math.min.apply(Math,rate_history);
    var min_age = rate_history.indexOf(min_rate);
    var min_balance = sched_bal(starting_balance, starting_term, starting_rate, min_age);
	var min_payment = pmt(min_balance, starting_term, min_rate);

    var o_min_rate = Math.min.apply(Math,rate_history.slice(0,210));
    var o_min_age = rate_history.indexOf(o_min_rate);
    var o_min_balance = sched_bal(starting_balance, starting_term, starting_rate, o_min_age);
	var o_min_payment = pmt(o_min_balance, starting_term, o_min_rate);

	//not completely accurate because we didnt re-amortize at refi;
	var total_payments_o_min_rate = starting_payment * o_min_age +
	                                o_min_payment * (payoff_age - o_min_age) +
	                                payoff_bal;

	var lowest_payments = Math.min(total_payments_naive,total_payments_o_min_rate);
	var savings = total_payments_naive - cumulative_payments;
	var max_savings = total_payments_naive - lowest_payments;

	var savings_score = 0;
	if (max_savings != 0)
	{
		savings_score = 100 * savings / max_savings;
	}

	txt = "<div>" + message + "</div>";
	//txt = txt + "<div>min_rate = " + o_min_rate + "%</div>";
	//txt = txt + "<div>min_age = " + o_min_age + "</div>";
	//txt = txt + "<div>min_balance = " + dollar(o_min_balance) + "</div>";
	//txt = txt + "<div>min_payment = " + dollar(o_min_payment) + "</div>";
	txt = txt + "<p><div>---Stats---</div></p?";
	txt = txt + "<div>Your Rate = " + loan_rate + "%</div>";
	txt = txt + "<div>Best Rate = " + min_rate + "%</div>";
	txt = txt + "<div>Worst Rate = " + max_rate + "%</div>";
	txt = txt + "<div> </div>";
	txt = txt + "<div>Your Total Payments = " + dollar(cumulative_payments) + "</div>";
	//txt = txt + "<div>Refi at Min Rate Payments = " + dollar(total_payments_o_min_rate) + "</div>";
	txt = txt + "<div>Minimum Possible Payments = " + dollar(lowest_payments) + "</div>";
	txt = txt + "<div>Total Payments Doing Nothing = " + dollar(total_payments_naive) + "</div>";
	txt = txt + "<div> </div>";
	txt = txt + "<div>You Saved = $" + dollar(savings) + " out of a possible $" + max_savings.toLocaleString() + "!  Good Job!</div>";
	//txt = txt + "<div>Savings Score = " + round(savings_score) + "%</div>";

	update("message",txt);
}

document.body.onkeydown = function(e){
    if(e.keyCode == 27){ //ESC
		window.location.reload();
		return false;
    }
    if (gameover)
    	return;

    if(e.keyCode == 9){ //tab
		skip(12);
    }
    if(e.keyCode == 32){ //space
		next_month();
    }
    if(e.keyCode == 80){ //P
		payoff();
    }
    if(e.keyCode == 82){ //R
		refi();
    }
    if(e.keyCode == 83){ //S
		skip();
    }

}
</script>
</body>
</html>