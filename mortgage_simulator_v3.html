<!DOCTYPE html>
<html>
<!--<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>-->
<script src="plotly-latest.min.js"></script>
<script src="mortgage_simulator.js"></script>
<head>
  <title>Mortgage Simulator</title>
  <link rel="stylesheet" href="mortgage_simulator.css">
</head>
<body>

<!--<div id="splashscreen" class="splashscreen">
   Welcome to the Mortgage Simulator<br>
  <br>
  <h1><a href = "javascript:toggle('splashscreen')">Buy a House!</a><h1>
</div>-->

<div class="navbar">

  <div class="dropdown">
     <a href="javascript:start_simulation()"><img id = "go_img" src="go.png" alt="Go" class="center"></a>
  </div>
  <div class="dropdown">
     <a href="javascript:next_month()"><img id = "forward_img" src="forward.png" alt="Forward" class="center"></a>
  </div>
  <div class="dropdown">
     <a href="javascript:prev_month()"><img id = "backward_img" src="backward.png" alt="Backward" class="center"></a>
  </div>
  <div class="dropdown">
     <a href=""><img id = "go_backward_img" src="go_backward.png" alt="Go Backward" class="center"></a>
  </div>
  <!--
  <div class="dropdown">
    <button class="dropbtn" id='simulate_btn' onclick="toggle('simulate_dropdown')">Simulate
      <small><small>&#9660;</small></small>
    </button>
    <div class="dropdown-content" id="simulate_dropdown">
      <a href="javascript:next_month()">One Month &nbsp<span class='right'> (Space)</span></a>
      <a href="javascript:skip()">To Maturity &nbsp<span class='right'> (M)</span></a>
      <a href="javascript:skip_until_rates_fall()">Until Rates Fall &nbsp<span class='right'> (N)</span></a>
      <a href="javascript:skip_until_possible_payoff()">Until Possible Payoff &nbsp<span class='right'> (B)</span></a>
    </div>
  </div>
  -->
  <div class="dropdown">
    <button class="dropbtn" id='refi_btn' onclick="toggle('refi_dropdown')">Actions
      <small><small>&#9660;</small></small>
    </button>
    <div class="dropdown-content" id="refi_dropdown">
      <a href="javascript:refi()">Refinance<span class='right'> (R)</span></a>
      <a href="javascript:cashout()">Cashout<span class='right'> (C)</span></a>
      <a href="javascript:payoff()">Payoff<span class='right'> (P)</span></a>
    </div>
  </div>
  <!--
  <div class="dropdown">
    <button class="dropbtn" id='settings_btn' onclick="toggle('settings_dropdown')">Settings
      <small><small>&#9660;</small></small>
    </button>
    <div class="dropdown-content" id="settings_dropdown">
      <a>Speed</a>
      <a>Alerts</a>
    </div>
  </div>
  -->
</div>

<a href="javascript:toggle('instructions')">---Instructions---</a>
<div id="instructions">Pay off the loan with the minimum amount of money possible
</div>
<br>

<div class='wrap'>
<div class='leftcol'>
<a href="javascript:toggle('finances')">---Finances---</a>
<div id="finances">
  <div id = "cash"></div>
  <div id = "income"></div>
  <div id = "cumulative_payments"></div>
</div>
<br>

<a href="javascript:toggle('loan')">---Loan---</a>
<div id="loan">
  <div id = "balance"></div>
  <div id = "rem_term"></div>
  <div id = "loan_rate"></div>
  <div id = "payment"></div>
</div>
<br>

<a href="javascript:toggle('rates')">---Rates---</a>
<div id="rates">
  <div id="new_term"></div>
  <div id="new_rate"></div>
  <div id="new_fees"></div>
</div>
<br>

<a href="javascript:toggle('house')">---House---</a>
<div id="house">
  <div id="orig_house_val"></div>
  <div id="cur_house_val"></div>
</div>
<br>

<a href="javascript:toggle('message')">---Message---</a>
<div id="message"></div>
</div>

</div><!-- End Left Column -->

<div class='rightcol'>
<a href="javascript:toggle('chart')">---Charts---</a>
<div id="chart">
  <div id="myPlot" style="width:100%;max-width:700px"></div>
  <div id="myPlot2" style="width:100%;max-width:700px"></div>
</div><!-- End Right Column -->


</div><!-- End Wrap-->
<script>
//global variables
var cash = 0;
var income = 3000;
var cumulative_payments = 0;

var orig_balance = 400000;
var balance = 400000;
var rem_term = 360;
var loan_rate = 4;
var payment = 1909.66;

var new_term = 360;
var new_rate = loan_rate;
var new_fees = 4000;
var change = 0.005;

var orig_house_val = 500000;
var cur_house_val = 500000;
var hpa_change = 3;

var counter=0;

var rate_history = [4,4,4.03,4.13,4.14,4.12,4.14,4.15,4.14,4.17,4.2,4.25,4.26,4.2,4.25,4.11,4.09,4.06,4.12,4.12,4.09,4.15,4.16,4.18,4.12,4.05,3.91,3.99,4.09,4.1,4.05,4.03,3.95,3.96,4,3.98,3.99,3.96,4,4.05,4.05,4.06,3.96,3.95,3.99,4.02,4.07,4.07,4.01,3.91,3.96,3.8,3.8,4.25,4.23,4.17,4.17,4.23,3.8,3.81,3.79,3.72,3.71,3.67,3.68,3.69,3.73,3.79,3.87,3.9,3.94,4.01,4.04,4.02,3.98,3.97,3.97,3.61,3.62,3.59,3.6,3.59,3.64,3.64,3.7,3.68,3.73,3.21,3.15,3.24,3.26,3.23,3.19,3.25,3.27,3.3,3.33,3.38,3.32,3.27,3.2,3.29,3.31,3.35,3.49,3.64,3.73,3.79,3.77,3.77,3.71,3.72,3.72,3.73,3.71,3.76,3.81,3.26,3.16,3.1,3.12,3.17,3.2,3.23,3.27,3.57,3.52,3.51,3.5,3.54,3.46,3.36,3.27,3.32,3.29,3.21,3.15,3.16,3.22,3.11,3.12,3.18,3.19,3.15,3.17,3.17,3.13,3.09,3.11,3.12,2.79,2.77,3.03,3.15,3.2,3.24,3.21,3.18,3.24,3.16,3.19,3.15,3.1,3.15,2.47,2.36,2.36,2.4,2.43,2.39,2.42,2.38,2.44,2.44,2.35,2.29,2.32,2.31,2.32,2.31,2.23,2.19,2.24,2.22,2.23,2.29,2.32,2.26,2.15,2.12,2.21,2.15,2.08,2.05,2.03,2.04,1.96,1.93,1.92,1.95,1.9,1.96,1.52,1.52,1.56,1.53,1.51,1.42,1.48,1.4,1.41,1.48,1.49,1.21,1.17,1.15,1.13,1.16,1.2,1.24,1.22,1.23,1.19,1.05,0.99,0.95,1.04,1.09,1.15,1.25,1.37,1.27,1.31,1.4,1.44,1.38,1.35,1.32,1.36,1.29,1.58,1.59,1.53,1.51,1.57,1.64,1.71,1.7,1.71,1.74,1.74,2.27,2.33,2.36,2.46,2.47,2.39,2.44,2.35,2.39,2.46,2.43,2.48,2.49,2.44,2.41,2.47,2.16,2.12,2.09,1.75,1.68,1.69,1.71,1.75,1.44,1.42,1.32,1.3,1.39,1.39,1.32,1.35,1.37,1.36,1.32,1.21,1.18,1.12,1.09,1.19,1.23,1.24,1.58,1.54,1.57,1.57,1.6,1.62,1.64,1.66,1.65,1.68,1.69,1.71,1.74,1.63,1.56,1.45,1.42,1.42,1.38,1.33,1.35,1.3,1.32,1.45,1.53,1.43,1.8,1.76,1.8,1.78,1.76,1.75,1.82,1.83,1.83,1.81,1.8,1.79,1.7,1.7,1.76,1.83,1.84,1.85,1.91,1.91,1.85,1.92,1.92,1.89,1.9,1.91,1.56,1.58,1.54,1.52,1.47,1.41,1.4,1.45,1.5,1.37,1.33,1.37,1.3,1.29,1.3,1.27];
var my_rate_history = [];
var optimal_rate_history = [];
var optimal_rate_history2 = [];


rate_history[0] = loan_rate;
my_rate_history[0] = loan_rate;
optimal_rate_history[0] = loan_rate;

var hpi_history = [];
hpi_history[0] = cur_house_val;

var min_rate = loan_rate;
var threshold = 1.0;
var record_rate = loan_rate - threshold;
update_all();
var gameover = false;
var go = false;
var break_payoff=true;

function update(elem_name, text)
{
	document.getElementById(elem_name).innerHTML = text;
}
function toggle(elem_name)
{
	elem = document.getElementById(elem_name);
	elem.style.display = (elem.style.display === 'block') ? 'none' : 'block';
}

function hide(elem_name)
{
	elem = document.getElementById(elem_name);
	//style = window.getComputedStyle(elem)
	elem.style.display = "none";
}

// Standard Normal variate using Box-Muller transform.
function randn(mean,stdev) {
    var u = 0, v = 0;
    while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
    while(v === 0) v = Math.random();
    return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v ) * stdev + mean;
}
function pmt(balance, term, rate)
{
	var r = rate / 1200;
	var payment = (balance * r) / (1 - (Math.pow( (1 + r) , term * -1)));
	return payment;
}
function sched_bal(balance, term, rate, age)
{
	var r = rate / 1200;
	var sched_bal = balance * (Math.pow(1+r,term) - Math.pow(1+r,age)) / (Math.pow(1+r,term) - 1);
	return sched_bal;
}
function ipmt(balance, term, rate)
{
	var interest = balance * rate / 1200;
	return interest;
}
function ppmt(balance, term, rate)
{
	var payment = pmt(balance, term, rate);
	var interest = ipmt(balance, term, rate);
	var principal = payment - interest;
	return principal;
}
function update_payment()
{
   payment = pmt(balance, rem_term, loan_rate);
   payment = +(payment.toFixed(2));

   update("payment","Current Payment=$" + payment);
}

function update_rates()
{
   new_rate = rate_history[counter]
   if (new_rate < min_rate) {
       min_rate = new_rate;
   }
   if (new_rate < record_rate) {
       record_rate = new_rate - threshold;
   }
   optimal_rate_history[optimal_rate_history.length] = min_rate;
}
function update_house_val()
{
   bigjump = Math.random() < 0.3;
   if (bigjump)
   {
       hpa_change = randn(3,12);
   }
   else
   {
       hpa_change = randn(hpa_change/2+3,2);
   }
   cur_house_val = cur_house_val * (1+hpa_change/1200);
   hpi_history[hpi_history.length] = cur_house_val;

}
function update_all(drawchart=true)
{
   update("cash", "Current Cash=" + dollar(cash));
   update("income", "Current Income=" + dollar(income));
   update("cumulative_payments", "Cumulative Payments=" + dollar(cumulative_payments));

   update("balance", "Current Balance=" + dollar(balance));
   update("rem_term", "Remaining Term=" + rem_term);
   update("loan_rate","Current Rate=" + loan_rate + "%");
   update("payment","Current Payment=" + dollar(payment));

   update("new_term", "Term=" + new_term);
   update("new_rate", "Rate=" + new_rate +"%");
   update("new_fees", "Fees=" + dollar(new_fees));

   update("orig_house_val", "Orig Value=" + dollar(orig_house_val));
   update("cur_house_val", "Cur Value=" + dollar(cur_house_val));

   update("message","");

   if (drawchart == true) {
   		chart();
   		chart2();
   }
}

function next_month(drawchart=true)
{
   if (gameover)
      return;

   counter = counter + 1;

   //finances
   cumulative_payments = cumulative_payments + payment;
   cash = cash + income - payment;
   cash = +(cash.toFixed(2));

   //loan
   var principal = ppmt(balance, rem_term, loan_rate);
   balance = balance - principal;
   rem_term = rem_term - 1;
   my_rate_history[my_rate_history.length] = loan_rate;

   balance = +(balance.toFixed(2));

   //rates
   update_rates();

   //house
   if ((counter % 3) == 0)
   {
   	   update_house_val();
   }

   //display
   update_all(drawchart);

   if (rem_term == 0)
   {
   	  optimized_refi_path("Loan is paid off!");
      gameover=true;
   }
}
function prev_month(drawchart=true)
{
   if (gameover)
      return;

   counter = counter - 1;

   //finances
   cumulative_payments = cumulative_payments - payment;
   cash = cash - income + payment;
   cash = +(cash.toFixed(2));

   //loan
   var principal = ppmt(balance, rem_term, loan_rate);
   balance = balance + principal;
   rem_term = rem_term + 1;
   //my_rate_history[my_rate_history.length] = loan_rate;

   balance = +(balance.toFixed(2));

   //rates
   new_rate = my_rate_history[counter]

   //house
   if ((counter % 3) == 0)
   {
   	   update_house_val();
   }

   //display
   update_all(drawchart);

   if (rem_term == 0)
   {
   	  optimized_refi_path("Loan is paid off!");
      gameover=true;
   }
}
function refi()
{
    if (cash < new_fees)
    {
    	update("message","Not Enough Cash to Refi")
    	return;
    }

	loan_rate = new_rate;
	rem_term = new_term;
	cash = cash - new_fees;
	cumulative_payments = cumulative_payments + new_fees;
	payment = pmt(balance, rem_term, loan_rate)
    payment = +(payment.toFixed(2));

    update_all();
    update("message","Refi Successful!")
}
function sleep(duration)
{
	return new Promise(resolve => {
		setTimeout(() => {
			resolve()
		}, duration)
	})
}
async function skip(months=rem_term, break_rate=record_rate, break_possible_payoff=break_payoff)
{
	var i;
	var months_left = Math.min(months,rem_term);
    for (i=0;i<months_left;i++)
	{
		if (go == false)
			return;

		next_month();

		await sleep(1);

		if (new_rate < break_rate)
		{
			update("message","Rates are at record lows!")
			go=false;
			document.getElementById("go_img").src="go.png";
			return;
		}

		if (break_possible_payoff && (cash >= balance))
		{
			update("message","Payoff Option Available");
			break_payoff=false;
			go=false;
			document.getElementById("go_img").src="go.png";
			return;
		}
	}
}
function cashout()
{
    if (cash < new_fees)
    {
    	update("message","Not Enough Cash to Refi")
    	return;
    }
	old_balance = balance
	balance = cur_house_val * 0.8;
	cashout_amt = balance - old_balance;
	cash = cash - new_fees + cashout_amt;

	loan_rate = new_rate;
	rem_term = new_term;

	cumulative_payments = cumulative_payments + new_fees;
	payment = pmt(balance, rem_term, loan_rate)
    payment = +(payment.toFixed(2));

    update_all();
    update("message","Cashout Successful!")
}
function payoff()
{
    if (cash < balance)
    {
    	update("message","Not Enough Cash to Pay Off Loan")
    	return;
    }
    cash = cash - balance;
	cumulative_payments = cumulative_payments + balance;
    //balance = 0;
    //rem_term = 0;
    //loan_rate = 0;
    //payment = 0;

	update_all();
    optimized_refi_path("Payoff Successful!");
    gameover=true;
}
function dollar(val)
{
	val = +(val.toFixed(2));
	return val.toLocaleString('en-US', {style:'currency', currency:'USD'});
}
function round(val)
{
	val = +(val.toFixed(2));
	return val;
}

function optimized_refi_path(message)
{
    //assume you refi-ed at min rate
    var starting_payment = 1909.66;
    var starting_term = 360;
    var starting_balance = 400000;
    var starting_rate = 4;
	var payoff_age = 142;

	var payoff_bal = sched_bal(starting_balance, starting_term, starting_rate, payoff_age);
	var total_payments_naive = starting_payment * starting_term;

    var max_rate = Math.max.apply(Math,rate_history);
    var min_rate = Math.min.apply(Math,rate_history);
    var min_age = rate_history.indexOf(min_rate);
    var min_balance = sched_bal(starting_balance, starting_term, starting_rate, min_age);
	var min_payment = pmt(min_balance, starting_term, min_rate);

    var o_min_rate = Math.min.apply(Math,rate_history.slice(0,payoff_age));
    var o_min_age = rate_history.indexOf(o_min_rate);
    var o_min_balance = sched_bal(starting_balance, starting_term, starting_rate, o_min_age);
	var o_min_payment = pmt(o_min_balance, starting_term, o_min_rate);

	for (i=0;i<payoff_age;i++)
	{
		if (i < o_min_age) {
			optimal_rate_history[i] = starting_rate;
		}
		else {
			optimal_rate_history[i] = o_min_rate;
		}
	}
	//not completely accurate because we didnt re-amortize at refi;
	var total_payments_o_min_rate = starting_payment * o_min_age +
	                                o_min_payment * (payoff_age - o_min_age) +
	                                payoff_bal;

	var lowest_payments = Math.min(total_payments_naive,total_payments_o_min_rate);
	var savings = total_payments_naive - cumulative_payments;
	var max_savings = total_payments_naive - lowest_payments;

	var savings_score = 0;
	if (max_savings != 0)
	{
		savings_score = 100 * savings / max_savings;
	}

	txt = "<div>" + message + "</div>";
	txt = txt + "<div>Lowest Rate = " + min_rate + "%</div>";
	txt = txt + "<div>Your Rate = " + loan_rate + "%</div>";
	txt = txt + "<div> </div>";
	txt = txt + "<div>Minimum Payments = " + dollar(lowest_payments) + "</div>";
	txt = txt + "<div>Scheduled Payments = " + dollar(total_payments_naive) + "</div>";
	txt = txt + "<div>Your Payments = " + dollar(cumulative_payments) + "</div>";
	txt = txt + "<div> </div>";
	txt = txt + "<div>Possible Savings = " + dollar(max_savings) + "</div>";
	txt = txt + "<div>Your Savings = " + dollar(savings) + "</div>";
	txt = txt + "<div>Savings Score = " + round(savings_score) + "%</div>";

	update("message",txt);
	chart(draw_optimal=1)
}
function chart(draw_optimal=1)
{
	var xvals = Array.from(Array(counter).keys());
	var x2vals = Array.from(Array(rate_history.length).keys());
	//var x2vals = Array.from(Array(optimal_rate_history.length).keys());

	var xlen = xvals.length;
	var rate_max=Math.max(rate_history)
	// Define Data
	var rates1 = {
	  x: xvals,
	  y: rate_history,
	  mode:"lines",
	  name:"market rate"
	};
	var rates2 = {
	  x: xvals,
	  y: my_rate_history,
	  mode:"lines",
	  name:"loan rate"
	};
	var rates3 = {
	  x: x2vals,
	  y: rate_history,
	  mode:"lines",
	  name:"future rate",
	  line: {
	  	dash: 'dot',
	    width: 2
  	  }
	};

	var data = [];
	if (draw_optimal) {
		data = [rates1,rates2,rates3];
	}
	else {
		data = [rates1,rates2];
	}

	// Define Layout
	var layout = {
	  xaxis: {range: [0, 360], title: "Month"},
	  yaxis: {range: [0, 8], title: "Rate"},
	  //title: "Rate History"
	};

	// Display using Plotly
	var myPlot = document.getElementById('myPlot')

	Plotly.newPlot(myPlot, data, layout);

	var dataRetrievedLater = myPlot.data;
	var layoutRetrievedLater = myPlot.layout;
}
function chart2()
{
	var xvals = Array.from(Array(hpi_history.length).keys());

	var xlen = xvals.length;
	var rate_max=Math.max(hpi_history)
	// Define Data
	var hpi = {
	  x: xvals,
	  y: hpi_history,
	  mode:"lines",
	  name:"house_vale"
	};

	// Define Layout
	var layout = {
	  xaxis: {range: [0, 360], title: "Month"},
	  yaxis: {range: [0, 1000000], title: "House Value"},
	  //title: "HPI"
	};

	// Display using Plotly
	var myPlot2 = document.getElementById('myPlot2')

	Plotly.newPlot(myPlot2, [hpi], layout);

	var dataRetrievedLater = myPlot2.data;
	var layoutRetrievedLater = myPlot2.layout;
}
function start_simulation()
{
	if (go==false)
	{
		go=true;
		document.getElementById("go_img").src="stop.png";
		skip();
	}
	else
	{
		go=false;
		document.getElementById("go_img").src="go.png";
	}
}
function skip_until_possible_payoff()
{
	skip(rem_term,break_rate=-1,break_possible_payoff=true);
}

function skip_until_rates_fall()
{
	skip(rem_term,break_rate=loan_rate);
}
document.body.onkeydown = function(e){
    if(e.keyCode == 27){ //ESC
		window.location.reload();
		return false;
    }
    if(e.keyCode == 81){ //Q
 		document.getElementById('instructions').innerHTML = rate_history;
    }
    if (gameover)
    	return;

    if(e.keyCode == 13){ //Enter
		go=false;
    }
    if(e.keyCode == 32){ //Space
		start_simulation();
    }
    if(e.keyCode == 190){ //Period
		next_month();
    }

    if(e.keyCode == 66){ //B
		go=true;
		skip_until_possible_payoff();
    }
    if(e.keyCode == 67){ //C
		cashout();
    }
    if(e.keyCode == 77){ //M
    	go=true;
		skip();
    }
    if(e.keyCode == 78){ //N
		go=true;
		skip_until_rates_fall();
    }
    if(e.keyCode == 80){ //P
		payoff();
    }
    if(e.keyCode == 82){ //R
		refi();
    }
    if(e.keyCode == 89){ //Y
 		skip(12);
    }
}

// Close the dropdown if the user clicks outside of it
window.onclick = function(e) {

  simulate_btn = document.getElementById('simulate_btn')
  refi_btn = document.getElementById('refi_btn')

  if (e.target != simulate_btn) {
  	//hide('simulate_dropdown')
  }
  if (e.target != refi_btn) {
  	hide('refi_dropdown')
  }

}
</script>
</body>
</html>