<!DOCTYPE html>
<html>
<!--<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>-->
<script src="plotly-latest.min.js"></script>
<script src="mortgage_simulator.js"></script>
<head>
  <title>Mortgage Simulator</title>
  <link rel="stylesheet" href="mortgage_simulator.css">
</head>
<body>

<!--<div id="splashscreen" class="splashscreen">
   Welcome to the Mortgage Simulator<br>
  <br>
  <h1><a href = "javascript:toggle('splashscreen')">Buy a House!</a><h1>
</div>-->

<div class="navbar">

  <div class="dropdown">
     <a href="javascript:start_simulation()"><img id = "go_img" src="go.png" alt="Go" class="center"></a>
  </div>
  <div class="dropdown">
     <a href="javascript:next_month()"><img id = "forward_img" src="forward.png" alt="Forward" class="center"></a>
  </div>
  <div class="dropdown">
     <a href="javascript:prev_month()"><img id = "backward_img" src="backward.png" alt="Backward" class="center"></a>
  </div>
  <div class="dropdown">
     <a href=""><img id = "go_backward_img" src="go_backward.png" alt="Go Backward" class="center"></a>
  </div>
  <!--
  <div class="dropdown">
    <button class="dropbtn" id='simulate_btn' onclick="toggle('simulate_dropdown')">Simulate
      <small><small>&#9660;</small></small>
    </button>
    <div class="dropdown-content" id="simulate_dropdown">
      <a href="javascript:next_month()">One Month &nbsp<span class='right'> (Space)</span></a>
      <a href="javascript:skip()">To Maturity &nbsp<span class='right'> (M)</span></a>
      <a href="javascript:skip_until_rates_fall()">Until Rates Fall &nbsp<span class='right'> (N)</span></a>
      <a href="javascript:skip_until_possible_payoff()">Until Possible Payoff &nbsp<span class='right'> (B)</span></a>
    </div>
  </div>
  -->
  <div class="dropdown">
    <button class="dropbtn" id='refi_btn' onclick="toggle('refi_dropdown')">Actions
      <small><small>&#9660;</small></small>
    </button>
    <div class="dropdown-content" id="refi_dropdown">
      <a href="javascript:refi()">Refinance<span class='right'> (R)</span></a>
      <a href="javascript:cashout()">Cashout<span class='right'> (C)</span></a>
      <a href="javascript:payoff()">Payoff<span class='right'> (P)</span></a>
    </div>
  </div>
  <!--
  <div class="dropdown">
    <button class="dropbtn" id='settings_btn' onclick="toggle('settings_dropdown')">Settings
      <small><small>&#9660;</small></small>
    </button>
    <div class="dropdown-content" id="settings_dropdown">
      <a>Speed</a>
      <a>Alerts</a>
    </div>
  </div>
  -->
</div>

<a href="javascript:toggle('instructions')">---Instructions---</a>
<div id="instructions">Pay off the loan with the minimum amount of money possible
</div>
<br>

<div class='wrap'>
<div class='leftcol'>
<a href="javascript:toggle('score')">---Total Score---</a>
<div id="score">
  <div id = "score"></div>
</div>
<br>

<a href="javascript:toggle('allocation')">---Allocation---</a>
<div id="allocation">
  <div id = "spend" style="display: inline-block;"></div>
  <div id = "change_spend" style="display: inline-block;">(<a href="javascript:change_spend(5)"> + </a> | <a href="javascript:change_spend(-5)"> - </a>)</div>
  <br>
  <div id = "invest" style="display: inline-block;"></div>
  <div id = "change_invest" style="display: inline-block;">(<a href="javascript:change_invest(5)"> + </a> | <a href="javascript:change_invest(-5)"> - </a>)</div>
  <br>
  <div id = "curtail" style="display: inline-block;"></div>
  <div id = "change_curtail" style="display: inline-block;">(<a href="javascript:change_curtail(5)"> + </a> | <a href="javascript:change_curtail(-5)"> - </a>)</div>
  <br>
  <div id = "save"></div>
</div>
<br>

<a href="javascript:toggle('finances')">---Finances---</a>
<div id="finances">
  <div id = "cash"></div>
  <div id = "investments"></div>
  <div id = "income"></div>
  <div id = "cumulative_payments"></div>
</div>
<br>

<a href="javascript:toggle('loan')">---Loan---</a>
<div id="loan">
  <div id = "balance"></div>
  <div id = "rem_term"></div>
  <div id = "loan_rate"></div>
  <div id = "payment"></div>
</div>
<br>

<a href="javascript:toggle('rates')">---Rates---</a>
<div id="rates">
  <div id="new_term"></div>
  <div id="new_rate"></div>
  <div id="new_fees"></div>
</div>
<br>

<a href="javascript:toggle('house')">---House---</a>
<div id="house">
  <div id="orig_house_val"></div>
  <div id="cur_house_val"></div>
</div>
<br>

<a href="javascript:toggle('stocks')">---Stocks---</a>
<div id="stocks">
  <div id="orig_stock_index"></div>
  <div id="cur_stock_index"></div>
  <div id="stock_change"></div>
</div>
<br>

<a href="javascript:toggle('inflation')">---Inflation---</a>
<div id="inflation">
  <div id="orig_inflation_index"></div>
  <div id="cur_inflation_index"></div>
</div>
<br>

<a href="javascript:toggle('message')">---Message---</a>
<div id="message"></div>
</div>

</div><!-- End Left Column -->

<div class='rightcol'>
<a href="javascript:toggle('chart')">---Charts---</a>
<div id="chart">
  <div id="myPlot" style="width:100%;max-width:700px"></div>
  <div id="myPlot2" style="width:100%;max-width:700px"></div>
  <div id="myPlot3" style="width:100%;max-width:700px"></div>
  <div id="myPlot4" style="width:100%;max-width:700px"></div>
</div><!-- End Right Column -->


</div><!-- End Wrap-->
<script>
//global variables
var score = 0;

var spend = 1000;
var save = 70.34;
var invest = 10.00;
var curtail = 10.00;

var cash = 0;
var investments = 0;
var income = 3000; //3000 (teacher) , 5000 (nurse), 10000 (banker)
var cumulative_payments = 0;

var orig_balance = 400000;
var balance = 400000;
var rem_term = 360;
var loan_rate = 4;
var payment = 1909.66;

var new_term = 360;
var new_rate = loan_rate;
var new_fees = 4000;
var change = 0.005;

var orig_house_val = 500000;
var cur_house_val = 500000;
var hpa_change = 3;

var orig_stock_index = 10000;
var cur_stock_index = 10000;
var stock_change = 3;

var orig_inflation_index = 100;
var cur_inflation_index = 100;
var inflation_change = 2;

var counter=0;
var fixed_rate_path = 1;

var rate_history = [];
rate_history[0] = loan_rate;
if (fixed_rate_path)
{
	rate_history = [4,4,4.03,4.13,4.14,4.12,4.14,4.15,4.14,4.17,4.2,4.25,4.26,4.2,4.25,4.11,4.09,4.06,4.12,4.12,4.09,4.15,4.16,4.18,4.12,4.05,3.91,3.99,4.09,4.1,4.05,4.03,3.95,3.96,4,3.98,3.99,3.96,4,4.05,4.05,4.06,3.96,3.95,3.99,4.02,4.07,4.07,4.01,3.91,3.96,3.8,3.8,4.25,4.23,4.17,4.17,4.23,3.8,3.81,3.79,3.72,3.71,3.67,3.68,3.69,3.73,3.79,3.87,3.9,3.94,4.01,4.04,4.02,3.98,3.97,3.97,3.61,3.62,3.59,3.6,3.59,3.64,3.64,3.7,3.68,3.73,3.21,3.15,3.24,3.26,3.23,3.19,3.25,3.27,3.3,3.33,3.38,3.32,3.27,3.2,3.29,3.31,3.35,3.49,3.64,3.73,3.79,3.77,3.77,3.71,3.72,3.72,3.73,3.71,3.76,3.81,3.26,3.16,3.1,3.12,3.17,3.2,3.23,3.27,3.57,3.52,3.51,3.5,3.54,3.46,3.36,3.27,3.32,3.29,3.21,3.15,3.16,3.22,3.11,3.12,3.18,3.19,3.15,3.17,3.17,3.13,3.09,3.11,3.12,2.79,2.77,3.03,3.15,3.2,3.24,3.21,3.18,3.24,3.16,3.19,3.15,3.1,3.15,2.47,2.36,2.36,2.4,2.43,2.39,2.42,2.38,2.44,2.44,2.35,2.29,2.32,2.31,2.32,2.31,2.23,2.19,2.24,2.22,2.23,2.29,2.32,2.26,2.15,2.12,2.21,2.15,2.08,2.05,2.03,2.04,1.96,1.93,1.92,1.95,1.9,1.96,1.52,1.52,1.56,1.53,1.51,1.42,1.48,1.4,1.41,1.48,1.49,1.21,1.17,1.15,1.13,1.16,1.2,1.24,1.22,1.23,1.19,1.05,0.99,0.95,1.04,1.09,1.15,1.25,1.37,1.27,1.31,1.4,1.44,1.38,1.35,1.32,1.36,1.29,1.58,1.59,1.53,1.51,1.57,1.64,1.71,1.7,1.71,1.74,1.74,2.27,2.33,2.36,2.46,2.47,2.39,2.44,2.35,2.39,2.46,2.43,2.48,2.49,2.44,2.41,2.47,2.16,2.12,2.09,1.75,1.68,1.69,1.71,1.75,1.44,1.42,1.32,1.3,1.39,1.39,1.32,1.35,1.37,1.36,1.32,1.21,1.18,1.12,1.09,1.19,1.23,1.24,1.58,1.54,1.57,1.57,1.6,1.62,1.64,1.66,1.65,1.68,1.69,1.71,1.74,1.63,1.56,1.45,1.42,1.42,1.38,1.33,1.35,1.3,1.32,1.45,1.53,1.43,1.8,1.76,1.8,1.78,1.76,1.75,1.82,1.83,1.83,1.81,1.8,1.79,1.7,1.7,1.76,1.83,1.84,1.85,1.91,1.91,1.85,1.92,1.92,1.89,1.9,1.91,1.56,1.58,1.54,1.52,1.47,1.41,1.4,1.45,1.5,1.37,1.33,1.37,1.3,1.29,1.3,1.27];
}

var my_rate_history = [];
my_rate_history[0] = loan_rate;

//TO DELETE
var optimal_rate_history = [];
var optimal_rate_history2 = [];
optimal_rate_history[0] = loan_rate;

var hpi_history = [];
hpi_history[0] = cur_house_val;
if (fixed_rate_path)
{
   hpi_history = [500000,501968.21,501337.06,500706.71,499788.61,495066.73,490389.46,489523.88,491228.2,492938.45,494901.69,480927.11,467347.13,462013.93,460513.24,459017.42,459005.3,460492.2,461983.91,465610.56,467384.18,469164.55,471079.28,474734.77,478418.62,481355.1,483376.82,485407.03,487913.41,491043.86,494194.39,489015.04,492277.38,495561.49,498204.82,501584.01,504986.12,499437.38,496790.49,494157.63,506359.43,511782.92,517264.5,524275.86,528010.55,531771.84,536063.32,541732.7,547462.04,551721.51,554458.76,557209.59,560082.6,562197.8,564320.98,566824.9,570483.14,574164.99,578352.85,582171.34,586015.04,589526.1,591960.99,594405.94,596407.85,598777.12,601155.8,596344.44,596146.33,595948.29,584930.11,581406.26,577903.64,580419.57,569336.29,558464.65,555108.63,553067.47,551033.82,552167.19,554432.35,556706.81,555599.84,555675.6,555751.37,571447.34,579037.04,586727.54,594316.1,598507.7,602728.86,608234.46,612083.99,615957.89,618084.96,620731.6,623389.57,626688.68,630881.32,635102.01,640404.14,644480.68,648583.17,651692.19,656633.74,661612.76,666283.81,670572.39,674888.58,677311.36,679560.16,681816.43,686989,691581.56,696204.82,699761.45,703883.65,708030.13,711012.64,714740.74,718488.39,722969.27,726719.08,730488.34,734009.62,737114.17,740231.86,741304.27,738869.88,736443.49,735781,718290.31,701215.4,696004.04,696024.85,696045.66,710388.55,719982.08,729705.17,738599.66,743902.77,749243.95,754200.12,757264.36,760341.05,764254.93,768789.39,773350.75,751386.3,742653.6,734022.4,733451.88,734463.25,735476.01,738506.55,744357.37,750254.55,755589.44,760017.53,764471.57,768686.95,771574.31,774472.52,777425.48,781493.46,785582.72,788648.9,793047.48,797470.59,803080.17,807802.42,812552.44,817280.24,823397.37,829560.29,837522.06,843829.24,850183.92,854842.12,862863.17,870959.48,875257.86,878877.65,882512.41,887842.04,891632.2,895438.54,900683.63,905418.55,910178.36,915409.95,920730.78,926082.54,915682.63,932626.9,949884.72,952336.28,955180.66,958033.54,959560.16,946750.16,934111.18,932483.68,934145.92,935811.12,940829.03,945829.96,950857.47,957850.07,964703.36,971605.69,977654.99,983575.15,989531.16,994961.35,1001076.12,1007228.47,1012891.22,1007510.25,1002157.87,1004485.83,1006006.45,1007529.37,1009339.42,1013554.99,1017788.16,1005072.07,995374.15,985769.8,985046.52,987071.97,989101.59,994001.93,974697.92,955768.8,948264.59,948478.51,948692.48,946762.26,947141.05,947519.99,953132.08,958736.15,964373.17,966670.94,945234.34,924273.11,916050.44,914629.21,913210.19,914659.04,916814.44,918974.92,922023.41,924936.64,927859.07,933627.45,940204.27,946827.42,953113.83,942980.39,932954.69,929686.54,930375.81,931065.59,933904.32,937270.95,940649.71,941733.62,942168.78,942604.14,944075.07,945369.33,946665.37,950453.7,956855.93,963301.28,970154.41,977884.81,985676.81,991524.43,997212.76,1002933.72,1008629.61,1014297.52,1019997.28,1028922.18,1036155.53,1043439.74,1049188.22,1030264.49,1011682.08,1005175.65,1002456.28,999744.27,998172.92,980739.64,963610.83,942366.53,931782.7,921317.74,917278.85,917642.82,918006.94,946698.73,959858.64,973201.48,982019.26,989775.35,997592.7,1004602.38,981967.1,959841.83,949815.53,948065.76,946319.21,951890.2,928306.8,905307.69,898963.29,896670.81,894384.18,893219.34,895376.58,897539.03,900493.46,898098.11,895709.13,894550.97,897859.15,901179.57,905530.21,910829.13,916159.06,920408.42,924953.38,929520.78,934363.98,942113.69,949927.68,948277.82,949536.61,950797.07,952367.52,955516.84,958676.57,964041.7,965147.03,966253.63,972012.62,978297.66,984623.34,988829.65,990090.66,991353.28,993316.58,998575.91,1003863.09,1007761.39,1005418.02,1003080.09];
}

var stock_history = [];
stock_history[0] = cur_stock_index;
if (fixed_rate_path)
{
	stock_history = [10000,10049.14,10113.01,10154.34,10214.28,10256.64,10324,10194.95,10067.51,10017.4,10043.6,10079.19,10082.85,10145.49,10186.5,10232.95,10289.19,10321.22,10357.54,10417.82,10491,10557.77,10642.79,10712.9,10799.95,10871.16,10735.27,10708.7,10709.37,10747.31,10781.06,10839.1,10911.29,10979.57,11056.15,10917.95,10885.77,10890.12,10920.07,10783.57,10648.78,10654.18,10680.45,10730.46,10794.18,10857.75,10901.06,10968.84,11039.54,11095.41,11140.11,11187.57,11047.73,11017.22,11046.62,11082.95,10944.41,10915.03,10944.75,10990.4,11096.33,10957.63,10820.66,10808.82,10836.45,10883.53,10948.47,11031.33,11126.58,11216,11297,11155.79,11139.59,11190.82,11242.27,11306.56,11388.51,11457.6,11571.8,11654.97,11743.84,11838.31,11901.39,11988.27,12051.93,12104.84,12164.93,12214.27,12309.81,12371.05,12425.54,12489,12537.41,12603.49,12702.01,12755.65,12815.06,12872.34,12918.87,12991.15,13033.86,13115.79,13208.31,13296.38,13386.77,13475.01,13514.47,13637.5,13467.03,13413.86,13473.42,13305,13295,13128.81,13113.91,13173.29,13233.34,13306.04,13384.1,13499.16,13330.42,13296.28,13364.52,13466.64,13621.46,13773.91,13924.47,14041.74,14149.71,14207.2,14300.89,14412.13,14474.09,14532.47,14625.57,14722.92,14834.91,14910.75,14998.99,15041.72,15133.94,15222.35,15324,15440.77,15546.26,15609.25,15753.5,15885.67,15983.82,16113.49,16228.22,16025.37,15983.75,16016.85,16125.5,16262.16,16385.09,16530.17,16657.53,16745.67,16799.34,16871.09,16955.93,17051.77,17126.06,17232.24,17355.62,17479.56,17624.52,17770.47,17924.59,18030.4,18160.71,18283.87,18412.87,18515.25,18638.57,18733.59,18851.66,19005.88,19213.87,19299.11,19457.54,19592.21,19741.56,19979.11,20192.67,20359.3,20495.56,20637,20812.13,20946.47,21060.65,21175.48,21304.12,21431.86,21464.6,21543.31,21669.92,21802.57,21955.97,22082.96,22232.73,22428.95,22646.19,22770.04,22871.49,22585.6,22548.55,22646.24,22800.69,22996.64,23207.96,23343.42,23051.63,23011,23060.43,23096.23,23175.02,23201.38,23336.97,23485.91,23637.8,23803.1,24023.83,24236.14,24484.13,24697.48,24913.05,25104.36,25250.72,25488.73,25764.19,25442.14,25395.12,25437.32,25542.46,25585.55,25698.13,25848.37,26030.04,26214.43,26444.07,26552.23,26725.19,26990.03,27224.02,27398.54,27593.64,27248.72,27173.59,27240.3,27286.34,26945.26,26849.54,26934.17,27057.25,27281.13,27461.84,27704.16,27846.82,27498.73,27371.54,27366.85,27499.53,27646.51,27863.92,28077.9,28235.38,27882.44,27756.07,27833.24,27924.07,28156.56,28394.38,28588.51,28804.65,29058.27,29223.47,29408.63,29514.92,29145.98,29118.88,29156.62,29274.27,29497.01,29722.7,29960.99,30171.2,29794.06,29735.86,29869.4,30011.44,30146.65,30335.85,30615.32,30830.76,31077.14,31185.6,31469.18,31704.23,31918.67,32098.6,32292.7,32563.03,32774.91,33044.49,33322.75,33679.75,33909.33,34217.56,34542.57,34976.05,35403.36,35719.35,36033.38,36305.42,35851.6,35670.31,35730.19,35869.88,35959.19,35509.7,35350.73,34908.85,34888.14,35018.09,35235.62,35482.01,35778.23,35331,35221.89,35411.72,35556.43,35807.39,36111,36341.41,36654.62,36936.88,37303.85,37528.93,37769.14,37297.03,37158.05,37255.57,37395.65,37566.32,37756.72,38071.52,38402.94,38629.69,38146.82,38036.7,38040.84,38196.19,38309.91,37831.04,37753.61,37849.82,38020.3,38191.38];
}
var inflation_history = [];
inflation_history[0] = cur_inflation_index;
if (fixed_rate_path)
{
   inflation_history = [100,100.17,100.51,100.66,100.85,100.93,101.25,101.15,101.05,101.17,101.18,101.42,101.66,101.97,102.33,102.53,102.51,102.78,103.02,103.34,103.48,103.9,104.39,105.06,105.73,106.04,106.41,106.82,107.2,107.7,107.96,108.45,108.8,109.15,109.62,109.86,110.1,110.48,110.72,110.88,111.26,111.55,111.99,112.45,113.2,113.68,114.44,115.15,115.87,116.38,116.82,117.37,118,118.37,118.92,119.13,119.34,119.74,120.09,120.63,121.18,121.72,121.98,122.33,122.88,123.42,123.9,124.41,124.93,125.17,125.08,125.19,125.3,125.31,125.62,126.49,127.07,127.98,128.58,129.14,129.37,129.4,129.77,130.55,131.34,131.92,132.36,132.72,133.58,134.28,134.73,135.11,135.57,136.18,136.42,136.85,137.28,138.13,138.78,139.57,140.22,140.85,141.22,141.66,142.44,143.31,143.51,144.13,144.75,145.56,146.17,146.63,146.8,147.07,147.57,147.93,148.28,148.85,149.34,149.62,149.9,150.82,151.23,151.78,152.08,152.08,152.78,153.34,153.96,154.59,155.05,155.02,154.99,155.39,156.09,157.19,157.68,158.14,158.91,159.64,160.52,161.5,162.09,162.59,163.09,163.72,164.07,165.08,165.88,166.42,166.9,167.25,167.9,168.61,169.21,170.03,170.86,171.63,172.49,173.4,173.77,174.32,174.91,176.11,177.18,178.31,179.44,179.58,179.72,180.25,180.76,181.7,182.95,183.88,184.9,185.67,186.59,187.28,188.03,189.22,190.42,191.31,192.26,193.47,193.77,194.43,194.65,195.2,195.66,196.51,197.01,197.22,197.43,197.89,198.24,198.45,199.21,200.02,200.77,201.47,202.24,203.53,205.04,205.78,206.52,207.28,208.14,209.13,210.34,210.8,211.52,212.2,212.98,213.44,214.27,215.1,215.94,216.26,216.13,216.65,217.51,218.77,219.45,220.25,220.97,221.59,222.73,223.88,225.04,226.1,227.1,228.45,228.62,229.39,230.15,230.62,231.26,232.14,233.87,235.52,237.18,238.37,240.21,241.01,242.46,243.83,245.58,247.36,248.84,249.79,250.99,250.91,250.83,250.82,250.73,251.54,252.28,252.84,253.18,253.41,253.95,254.7,256.05,256.41,256.77,257.45,258.14,259.53,261.39,264.1,265.67,266.93,267.24,267.21,267.62,267.44,267.26,267.44,268.39,269.25,269.27,269.5,269.59,269.71,270.5,271.19,272.09,273.05,274.02,274.39,274.84,274.61,274.49,274.5,274.6,274.89,275.5,275.71,276.29,277.68,279.08,279.72,280.72,281.72,283.24,284.97,286.38,287.31,288.7,289.81,290.33,291.2,292.07,293.33,294.82,296.12,297.03,298.56,299.83,301.06,301.59,303.02,304.37,304.83,305.29,306.37,307.31,308.69,310.19,312.19,313.86,315.12,315.91,317.87,318.6,319.69,320.78,322,323.92,325.73,327.44,329.24,329.21,330.88,331.79,332.91,334.65,336.3,337.96,339.93,341.74,343.8,346.16,348.07,349.44,351.09,352.89,355.29,356.46,357.86,359.27];
}
var min_rate = loan_rate;
var threshold = 99.0;
var record_rate = loan_rate - threshold;
update_all();
var gameover = false;
var go = false;
var break_payoff=true;

function update(elem_name, text)
{
	document.getElementById(elem_name).innerHTML = text;
}
function toggle(elem_name)
{
	elem = document.getElementById(elem_name);
	elem.style.display = (elem.style.display === 'block') ? 'none' : 'block';
}
function check_allocation(amt,value1,value2)
{
	change_amt = amt;
	if ((change_amt + value1) < 0)
	{
		change_amt = value1;
	}
	if ((value2 - change_amt) < 0)
	{
		change_amt = value2;
	}
	return change_amt;
}
function update_allocation()
{
   update("spend", "Spend=" + dollar(spend));
   update("invest", "Invest=" + dollar(invest));
   update("curtail", "Curtail=" + dollar(curtail));
   update("save", "Save=" + dollar(save));
}
function change_spend(amt)
{
	change_amt = check_allocation(amt,spend,save);
	spend += change_amt;
	save -= change_amt;
	update_allocation()
}
function change_invest(amt)
{
	change_amt = check_allocation(amt,invest,save);
	invest += change_amt;
	save -= change_amt;
	update_allocation();
}
function change_curtail(amt)
{
	change_amt = check_allocation(amt,curtail,save);
	curtail += change_amt;
	save -= change_amt;
	update_allocation();
}
function hide(elem_name)
{
	elem = document.getElementById(elem_name);
	//style = window.getComputedStyle(elem)
	elem.style.display = "none";
}

// Standard Normal variate using Box-Muller transform.
function randn(mean,stdev) {
    var u = 0, v = 0;
    while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
    while(v === 0) v = Math.random();
    return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v ) * stdev + mean;
}
function pmt(balance, term, rate)
{
	var r = rate / 1200;
	var payment = (balance * r) / (1 - (Math.pow( (1 + r) , term * -1)));
	return payment;
}
function sched_bal(balance, term, rate, age)
{
	var r = rate / 1200;
	var sched_bal = balance * (Math.pow(1+r,term) - Math.pow(1+r,age)) / (Math.pow(1+r,term) - 1);
	return sched_bal;
}
function ipmt(balance, term, rate)
{
	var interest = balance * rate / 1200;
	return interest;
}
function ppmt(balance, term, rate)
{
	var payment = pmt(balance, term, rate);
	var interest = ipmt(balance, term, rate);
	var principal = payment - interest;
	return principal;
}
function update_payment()
{
   payment = pmt(balance, rem_term, loan_rate);
   payment = +(payment.toFixed(2));

   update("payment","Current Payment=$" + payment);
}

function update_rates(update=1,fixed_rate_path=0)
{
   if (update)
   {
      if (fixed_rate_path)
      {
		   new_rate = rate_history[counter];
	  }
	  else
	  {
		   bigjump = Math.random() < 0.1;
		   if (bigjump)
		   {
		   	  change = randn(0,0.25);
		   }
		   else
		   {
		      change = randn(change/10,0.05);
		   }
		   new_rate = new_rate + change;
		   new_rate = +(new_rate.toFixed(2));
	       rate_history[rate_history.length] = new_rate;
	  }
   }

   if (new_rate < min_rate) {
       min_rate = new_rate;
   }
   if (new_rate < record_rate) {
       record_rate = new_rate - threshold;
   }
   optimal_rate_history[optimal_rate_history.length] = min_rate;
}

function update_house_val(update=1,fixed_rate_path=0)
{
   if (update)
   {
       if (fixed_rate_path)
       {
   		   cur_house_val = hpi_history[counter];
	   }
	   else
	   {
		   bigdrop = Math.random() < 0.1;
		   bigjump = Math.random() > 0.9;
		   if (bigjump)
		   {
			   hpa_change = randn(5,15);
		   }
		   else if (bigdrop)
		   {
			   hpa_change = randn(-20,-10);
		   }
		   else
		   {
			   hpa_change = randn(hpa_change/2+3,2);
		   }
		   cur_house_val = cur_house_val * (1+hpa_change/1200);
		   cur_house_val = +(cur_house_val.toFixed(2));
	       hpi_history[hpi_history.length] = cur_house_val;
	   }
   }
}
function update_stocks(update=1,fixed_rate_path=0)
{
   bigdrop = Math.random() < 0.1;
   if (bigdrop)
   {
       stock_change = -15 * Math.random();
   }
   else
   {
       stock_change = randn(stock_change/2+4,2);
   }
   cur_stock_index = cur_stock_index * (1+stock_change/1200);
   cur_stock_index = +(cur_stock_index.toFixed(2));
   stock_history[stock_history.length] = cur_stock_index;
}
function update_inflation(update=0)
{
   if (update)
   {
       inflation_change = randn(inflation_change/2+2,2);
   }
   cur_inflation_index = cur_inflation_index * (1+inflation_change/1200);
   cur_inflation_index = +(cur_inflation_index.toFixed(2));
   inflation_history[inflation_history.length] = cur_inflation_index;

}
function update_all(drawchart=true)
{
   update("score", "Total Score=" + score);

   update("spend", "Spend=" + dollar(spend));
   update("invest", "Invest=" + dollar(invest));
   update("curtail", "Curtail=" + dollar(curtail));
   update("save", "Save=" + dollar(save));

   update("cash", "Current Cash=" + dollar(cash));
   update("investments", "Current Investments=" + dollar(investments));
   update("income", "Current Income=" + dollar(income));
   update("cumulative_payments", "Cumulative Payments=" + dollar(cumulative_payments));

   update("balance", "Current Balance=" + dollar(balance));
   update("rem_term", "Remaining Term=" + rem_term);
   update("loan_rate","Current Rate=" + loan_rate + "%");
   update("payment","Current Payment=" + dollar(payment));

   update("new_term", "Term=" + new_term);
   update("new_rate", "Rate=" + new_rate +"%");
   update("new_fees", "Fees=" + dollar(new_fees));

   update("orig_house_val", "Orig Value=" + dollar(orig_house_val));
   update("cur_house_val", "Cur Value=" + dollar(cur_house_val));

   update("orig_stock_index", "Orig Value=" + dollar(orig_stock_index));
   update("cur_stock_index", "Cur Value=" + dollar(cur_stock_index));
   update("stock_change", "Last Month Return=" + round(stock_change) + "%");

   update("orig_inflation_index", "Orig Value=" + orig_inflation_index);
   update("cur_inflation_index", "Cur Value=" + cur_inflation_index);

   update("message","");

   if (drawchart == true) {
   		chart();
   		chart2();
   		chart3();
   		chart4();
   }
}

function next_month(drawchart=true)
{
   if (gameover)
      return;

   counter = counter + 1;

   //finances
   cumulative_payments = cumulative_payments + payment;

   cash += save;
   cash = +(cash.toFixed(2));

   //loan
   var principal = ppmt(balance, rem_term, loan_rate);
   balance = balance - principal - curtail;
   rem_term = rem_term - 1; //TODO:re-calculate
   my_rate_history[my_rate_history.length] = loan_rate;

   balance = +(balance.toFixed(2));

   //score
   score = score + (spend + 1000) /10;

   //rates
   update_rates(1,fixed_rate_path);

   //house
   do_update = counter % 3;
   update_house_val(do_update);

   //stocks
   update_stocks();

   //inflation
   do_update = counter % 12;
   update_inflation(do_update);

   //invests after stocks
   investment_return = stock_change / 1200 + 1;
   investments = investments * investment_return + invest;
   investments = +(investments.toFixed(2));

   //display
   update_all(drawchart);

   if (rem_term == 0)
   {
   	  optimized_refi_path("Loan is paid off!");
      gameover=true;
   }
}
function refi()
{
    if (cash < new_fees)
    {
    	update("message","Not Enough Cash to Refi")
    	return;
    }

	loan_rate = new_rate;
	rem_term = new_term;
	cash = cash - new_fees;
	cumulative_payments = cumulative_payments + new_fees;
	payment = pmt(balance, rem_term, loan_rate)
    payment = +(payment.toFixed(2));

    update_all();
    update("message","Refi Successful!")
}
function sleep(duration)
{
	return new Promise(resolve => {
		setTimeout(() => {
			resolve()
		}, duration)
	})
}
async function skip(months=rem_term, break_rate=record_rate, break_possible_payoff=break_payoff)
{
	var i;
	var months_left = Math.min(months,rem_term);
    for (i=0;i<months_left;i++)
	{
		if (go == false)
			return;

		next_month();

		await sleep(1);

		if (new_rate < break_rate)
		{
			update("message","Rates are at record lows!")
			go=false;
			document.getElementById("go_img").src="go.png";
			return;
		}

		if (break_possible_payoff && (cash >= balance))
		{
			update("message","Payoff Option Available");
			break_payoff=false;
			go=false;
			document.getElementById("go_img").src="go.png";
			return;
		}
	}
}
function cashout()
{
    if (cash < new_fees)
    {
    	update("message","Not Enough Cash to Refi")
    	return;
    }
	old_balance = balance
	balance = cur_house_val * 0.8;
	cashout_amt = balance - old_balance;
	cash = cash - new_fees + cashout_amt;

	loan_rate = new_rate;
	rem_term = new_term;

	cumulative_payments = cumulative_payments + new_fees;
	payment = pmt(balance, rem_term, loan_rate)
    payment = +(payment.toFixed(2));

    update_all();
    update("message","Cashout Successful!")
}
function payoff()
{
    if (cash < balance)
    {
    	update("message","Not Enough Cash to Pay Off Loan")
    	return;
    }
    cash = cash - balance;
	cumulative_payments = cumulative_payments + balance;
    //balance = 0;
    //rem_term = 0;
    //loan_rate = 0;
    //payment = 0;

	update_all();
    optimized_refi_path("Payoff Successful!");
    gameover=true;
}
function dollar(val)
{
	val = +(val.toFixed(2));
	return val.toLocaleString('en-US', {style:'currency', currency:'USD'});
}
function round(val)
{
	val = +(val.toFixed(2));
	return val;
}

function optimized_refi_path(message)
{
    //assume you refi-ed at min rate
    var starting_payment = 1909.66;
    var starting_term = 360;
    var starting_balance = 400000;
    var starting_rate = 4;
	var payoff_age = 142;

	var payoff_bal = sched_bal(starting_balance, starting_term, starting_rate, payoff_age);
	var total_payments_naive = starting_payment * starting_term;

    var max_rate = Math.max.apply(Math,rate_history);
    var min_rate = Math.min.apply(Math,rate_history);
    var min_age = rate_history.indexOf(min_rate);
    var min_balance = sched_bal(starting_balance, starting_term, starting_rate, min_age);
	var min_payment = pmt(min_balance, starting_term, min_rate);

    var o_min_rate = Math.min.apply(Math,rate_history.slice(0,payoff_age));
    var o_min_age = rate_history.indexOf(o_min_rate);
    var o_min_balance = sched_bal(starting_balance, starting_term, starting_rate, o_min_age);
	var o_min_payment = pmt(o_min_balance, starting_term, o_min_rate);

	for (i=0;i<payoff_age;i++)
	{
		if (i < o_min_age) {
			optimal_rate_history[i] = starting_rate;
		}
		else {
			optimal_rate_history[i] = o_min_rate;
		}
	}
	//not completely accurate because we didnt re-amortize at refi;
	var total_payments_o_min_rate = starting_payment * o_min_age +
	                                o_min_payment * (payoff_age - o_min_age) +
	                                payoff_bal;

	var lowest_payments = Math.min(total_payments_naive,total_payments_o_min_rate);
	var savings = total_payments_naive - cumulative_payments;
	var max_savings = total_payments_naive - lowest_payments;

	var savings_score = 0;
	if (max_savings != 0)
	{
		savings_score = 100 * savings / max_savings;
	}

	txt = "<div>" + message + "</div>";
	txt = txt + "<div>Lowest Rate = " + min_rate + "%</div>";
	txt = txt + "<div>Your Rate = " + loan_rate + "%</div>";
	txt = txt + "<div> </div>";
	txt = txt + "<div>Minimum Payments = " + dollar(lowest_payments) + "</div>";
	txt = txt + "<div>Scheduled Payments = " + dollar(total_payments_naive) + "</div>";
	txt = txt + "<div>Your Payments = " + dollar(cumulative_payments) + "</div>";
	txt = txt + "<div> </div>";
	txt = txt + "<div>Possible Savings = " + dollar(max_savings) + "</div>";
	txt = txt + "<div>Your Savings = " + dollar(savings) + "</div>";
	txt = txt + "<div>Savings Score = " + round(savings_score) + "%</div>";

	update("message",txt);
	chart(draw_optimal=1)
}
function chart()
{
	var xvals = Array.from(Array(counter).keys());
	var x2vals = Array.from(Array(rate_history.length).keys());

	var xlen = xvals.length;
	var rate_max=Math.max(rate_history)
	// Define Data
	var rates1 = {
	  x: xvals,
	  y: rate_history,
	  mode:"lines",
	  name:"market rate"
	};
	var rates2 = {
	  x: xvals,
	  y: my_rate_history,
	  mode:"lines",
	  name:"loan rate"
	};
	var rates3 = {
	  x: x2vals,
	  y: rate_history,
	  mode:"lines",
	  name:"future rate",
	  line: {
	  	dash: 'dot',
	    width: 2
  	  }
	};

	var data = [];
	if (fixed_rate_path) {
		data = [rates1,rates2,rates3];
	}
	else {
		data = [rates1,rates2];
	}

	// Define Layout
	var layout = {
	  title: {text:'Rates'},
	  xaxis: {range: [0, 360], title: "Month"},
	  yaxis: {range: [0, 8], title: "Rate"},
	};

	// Display using Plotly
	var myPlot = document.getElementById('myPlot')

	Plotly.newPlot(myPlot, data, layout);

	var dataRetrievedLater = myPlot.data;
	var layoutRetrievedLater = myPlot.layout;
}
function chart2()
{
	var xvals = Array.from(Array(counter).keys());
	var x2vals = Array.from(Array(hpi_history.length).keys());

	var xlen = xvals.length;
	var rate_max=Math.max(hpi_history)
	// Define Data
	var hpi1 = {
	  x: xvals,
	  y: hpi_history,
	  mode:"lines",
	  name:"house_value"
	};
	var hpi2 = {
	  x: x2vals,
	  y: hpi_history,
	  mode:"lines",
	  name:"future_value",
	  line: {
	  	dash: 'dot',
	  	width: 2
  	  }
	};

	var data = [];
	if (fixed_rate_path) {
		data = [hpi1,hpi2];
	}
	else {
		data = [hpi1];
	}

	// Define Layout
	var layout = {
	  title: {text:'Home Prices'},
	  xaxis: {range: [0, 360], title: "Month"},
	  yaxis: {range: [0, 1000000], title: "House Value"},
	};

	// Display using Plotly
	var myPlot2 = document.getElementById('myPlot2')

	Plotly.newPlot(myPlot2, data, layout);

	var dataRetrievedLater = myPlot2.data;
	var layoutRetrievedLater = myPlot2.layout;
}
function chart3()
{
	var xvals = Array.from(Array(counter).keys());
	var x2vals = Array.from(Array(hpi_history.length).keys());

	var xlen = xvals.length;
	var rate_max=Math.max(stock_history)
	// Define Data
	var stocks1 = {
	  x: xvals,
	  y: stock_history,
	  mode:"lines",
	  name:"stock_index"
	};
	var stocks2 = {
	  x: x2vals,
	  y: stock_history,
	  mode:"lines",
	  name:"future_index",
	  line: {
	  	dash: 'dot',
	  	width: 2
  	  }
	};

	var data = [];
	if (fixed_rate_path) {
		data = [stocks1,stocks2];
	}
	else {
		data = [stocks1];
	}

	// Define Layout
	var layout = {
	  title: {text:'Stocks'},
	  xaxis: {range: [0, 360], title: "Month"},
	  yaxis: {range: [0, 50000], title: "Index"},
	};

	// Display using Plotly
	var myPlot3 = document.getElementById('myPlot3')

	Plotly.newPlot(myPlot3, data, layout);

	var dataRetrievedLater = myPlot3.data;
	var layoutRetrievedLater = myPlot3.layout;
}
function chart4()
{
	var xvals = Array.from(Array(counter).keys());
	var x2vals = Array.from(Array(inflation_history.length).keys());

	var xlen = xvals.length;
	var rate_max=Math.max(inflation_history)
	// Define Data
	var inflation1 = {
	  x: xvals,
	  y: inflation_history,
	  mode:"lines",
	  name:"inflation"
	};
	var inflation2 = {
	  x: x2vals,
	  y: inflation_history,
	  mode:"lines",
	  name:"future_index",
	  line: {
	  	dash: 'dot',
	  	width: 2
  	  }
	};

	var data = [];
	if (fixed_rate_path) {
		data = [inflation1,inflation2];
	}
	else {
		data = [inflation1];
	}

	// Define Layout
	var layout = {
	  title: {text:'Inflation'},
	  xaxis: {range: [0, 360], title: "Month"},
	  yaxis: {range: [0, 500], title: "Index"},
	};

	// Display using Plotly
	var myPlot4 = document.getElementById('myPlot4')

	Plotly.newPlot(myPlot4, data, layout);

	var dataRetrievedLater = myPlot4.data;
	var layoutRetrievedLater = myPlot4.layout;
}
function start_simulation()
{
	if (go==false)
	{
		go=true;
		document.getElementById("go_img").src="stop.png";
		skip();
	}
	else
	{
		go=false;
		document.getElementById("go_img").src="go.png";
	}
}
function skip_until_possible_payoff()
{
	skip(rem_term,break_rate=-1,break_possible_payoff=true);
}

function skip_until_rates_fall()
{
	skip(rem_term,break_rate=loan_rate);
}
document.body.onkeydown = function(e){
    if(e.keyCode == 27){ //ESC
		window.location.reload();
		return false;
    }
    if(e.keyCode == 81){ //Q
 		document.getElementById('instructions').innerHTML = rate_history;
    }
    if (gameover)
    	return;

    if(e.keyCode == 13){ //Enter
		go=false;
    }
    if(e.keyCode == 32){ //Space
		start_simulation();
    }
    if(e.keyCode == 190){ //Period
		next_month();
    }

    if(e.keyCode == 66){ //B
		go=true;
		skip_until_possible_payoff();
    }
    if(e.keyCode == 67){ //C
		cashout();
    }
    if(e.keyCode == 77){ //M
    	go=true;
		skip();
    }
    if(e.keyCode == 78){ //N
		go=true;
		skip_until_rates_fall();
    }
    if(e.keyCode == 80){ //P
		payoff();
    }
    if(e.keyCode == 82){ //R
		refi();
    }
    if(e.keyCode == 89){ //Y
 		skip(12);
    }
}

// Close the dropdown if the user clicks outside of it
window.onclick = function(e) {

  simulate_btn = document.getElementById('simulate_btn')
  refi_btn = document.getElementById('refi_btn')

  if (e.target != simulate_btn) {
  	//hide('simulate_dropdown')
  }
  if (e.target != refi_btn) {
  	hide('refi_dropdown')
  }

}
</script>
</body>
</html>